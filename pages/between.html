<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>between - townhaus</title>
    <link rel="stylesheet" href="../shared.css">
    <style>
        :root {
            --threshold-glow: rgba(212, 160, 86, 0.15);
            --liminal-mist: rgba(245, 241, 235, 0.8);
            --void-whisper: rgba(45, 55, 72, 0.03);
            --neither: rgba(139, 105, 20, 0.08);
            --both: rgba(134, 179, 152, 0.06);
        }

        body {
            background: var(--bone);
            min-height: 100vh;
            overflow: hidden;
            transition: all 1.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.full-between {
            background: var(--amber-glow);
        }

        body.liminal {
            filter: blur(1px) brightness(1.05) saturate(0.9);
        }

        body.dissolved {
            background: linear-gradient(180deg, var(--bone) 0%, var(--amber-glow) 50%, var(--bone) 100%);
        }

        body.dwelling {
            background: linear-gradient(180deg,
                var(--paper) 0%,
                var(--bone) 30%,
                rgba(212, 160, 86, 0.08) 50%,
                var(--bone) 70%,
                var(--paper) 100%
            );
        }

        body.profound {
            background: radial-gradient(ellipse at center,
                rgba(232, 184, 109, 0.12) 0%,
                var(--bone) 60%,
                var(--paper) 100%
            );
        }

        /* The space between spaces - ambient layer */
        .ambient-field {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 3s ease;
        }

        .ambient-field::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse at 30% 20%, var(--neither) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, var(--both) 0%, transparent 50%);
            animation: ambient-drift 30s ease-in-out infinite alternate;
        }

        @keyframes ambient-drift {
            0% { opacity: 0.3; transform: scale(1) rotate(0deg); }
            100% { opacity: 0.6; transform: scale(1.1) rotate(1deg); }
        }

        body.dwelling .ambient-field {
            opacity: 1;
        }

        /* Ambient particles floating in the between */
        .ambient-particle {
            position: fixed;
            width: 2px;
            height: 2px;
            background: var(--amber);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes particle-drift {
            0% {
                opacity: 0;
                transform: translateY(100vh) translateX(0);
            }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% {
                opacity: 0;
                transform: translateY(-100vh) translateX(var(--drift, 20px));
            }
        }

        /* Threshold dust - appears after stillness */
        .threshold-dust {
            position: fixed;
            width: 1px;
            height: 1px;
            background: var(--amber);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 4;
            filter: blur(0.5px);
        }

        @keyframes dust-suspend {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0.2;
            }
            25% {
                transform: translateY(-3px) translateX(2px);
                opacity: 0.4;
            }
            50% {
                transform: translateY(-1px) translateX(-1px);
                opacity: 0.3;
            }
            75% {
                transform: translateY(-4px) translateX(1px);
                opacity: 0.35;
            }
        }

        /* Two halves - here and there */
        .half {
            position: fixed;
            top: 0;
            height: 100%;
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 1.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .half::before {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 1.2s ease;
        }

        .half::after {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 2s ease;
            pointer-events: none;
        }

        .half.left {
            left: 0;
            background: linear-gradient(90deg, var(--paper) 0%, var(--bone) 100%);
        }

        .half.left::before {
            background: radial-gradient(ellipse at right center, var(--void-whisper) 0%, transparent 70%);
        }

        .half.left::after {
            background: radial-gradient(ellipse at 80% 50%, var(--neither) 0%, transparent 40%);
        }

        .half.right {
            right: 0;
            background: linear-gradient(90deg, var(--bone) 0%, var(--paper) 100%);
        }

        .half.right::before {
            background: radial-gradient(ellipse at left center, var(--void-whisper) 0%, transparent 70%);
        }

        .half.right::after {
            background: radial-gradient(ellipse at 20% 50%, var(--both) 0%, transparent 40%);
        }

        .half:hover::before {
            opacity: 1;
        }

        body.dwelling .half::after {
            opacity: 1;
        }

        .half-text {
            font-size: 2rem;
            font-weight: 300;
            color: var(--slate);
            opacity: 0.25;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3em;
            user-select: none;
            animation: half-breathe 8s ease-in-out infinite;
        }

        @keyframes half-breathe {
            0%, 100% { opacity: 0.25; letter-spacing: 0.3em; }
            50% { opacity: 0.3; letter-spacing: 0.35em; }
        }

        .half-subtext {
            position: absolute;
            font-size: 0.65rem;
            color: var(--slate);
            opacity: 0;
            transition: all 0.8s ease 0.3s;
            font-style: italic;
            letter-spacing: 0.1em;
            margin-top: 3.5rem;
        }

        .half-whisper {
            position: absolute;
            font-size: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--slate);
            opacity: 0;
            transition: all 1.5s ease;
            letter-spacing: 0.15em;
            margin-top: 6rem;
        }

        .half:hover .half-text {
            opacity: 0.6;
            letter-spacing: 0.5em;
            animation: none;
        }

        .half:hover .half-subtext {
            opacity: 0.35;
        }

        body.dwelling .half-whisper {
            opacity: 0.2;
        }

        /* The between line - the threshold itself */
        .between-line {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg,
                transparent 0%,
                var(--amber) 15%,
                var(--amber) 50%,
                var(--amber) 85%,
                transparent 100%
            );
            opacity: 0.2;
            z-index: 10;
            transition: all 1.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .between-line::before,
        .between-line::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--amber);
            border-radius: 50%;
            opacity: 0.5;
        }

        .between-line::before {
            top: 15%;
            animation: threshold-pulse 6s ease-in-out infinite;
        }

        .between-line::after {
            bottom: 15%;
            animation: threshold-pulse 6s ease-in-out infinite 3s;
        }

        @keyframes threshold-pulse {
            0%, 100% { opacity: 0.3; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.6; transform: translateX(-50%) scale(1.3); }
        }

        /* Line breathing animation */
        @keyframes line-breathe {
            0%, 100% {
                opacity: 0.2;
                filter: blur(0px);
            }
            50% {
                opacity: 0.35;
                filter: blur(0.5px);
            }
        }

        body.breathing .between-line {
            animation: line-breathe 6s ease-in-out infinite;
        }

        /* Deep breathing after long stillness */
        @keyframes line-deep-breathe {
            0%, 100% {
                opacity: 0.25;
                width: 1px;
                filter: blur(0px);
            }
            50% {
                opacity: 0.45;
                width: 3px;
                filter: blur(1px);
            }
        }

        body.deep-breathing .between-line {
            animation: line-deep-breathe 8s ease-in-out infinite;
        }

        /* The between zone - interactive threshold */
        .between-zone {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 100%;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 1.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .between-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, var(--threshold-glow) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .between-zone:hover::before {
            opacity: 1;
        }

        .between-content {
            font-size: 0.85rem;
            font-style: italic;
            color: var(--ink);
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.15em;
        }

        .between-zone:hover .between-content {
            opacity: 0.4;
        }

        /* Expanded state - the between opens */
        body.expanded .half.left {
            width: 25%;
            opacity: 0.7;
        }

        body.expanded .half.right {
            width: 25%;
            opacity: 0.7;
        }

        body.expanded .half-text {
            opacity: 0.15;
            font-size: 1.5rem;
            animation: none;
        }

        body.expanded .between-line {
            width: 50%;
            opacity: 0.08;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--amber-glow) 30%,
                var(--amber-glow) 70%,
                transparent 100%
            );
        }

        body.expanded .between-line::before,
        body.expanded .between-line::after {
            opacity: 0;
        }

        body.expanded .between-zone {
            width: 50%;
        }

        body.expanded .between-content {
            writing-mode: horizontal-tb;
            font-size: 1.1rem;
            opacity: 0.5;
            letter-spacing: 0.2em;
        }

        /* Messages in the between - the whispers */
        .between-messages {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0;
            transition: opacity 1.5s ease;
            z-index: 30;
            pointer-events: none;
        }

        body.expanded .between-messages {
            opacity: 1;
        }

        .between-message {
            font-size: 1rem;
            color: var(--ink);
            margin: 1.2rem 0;
            opacity: 0;
            transform: translateY(15px) scale(0.98);
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.05em;
        }

        .between-message.visible {
            opacity: 0.55;
            transform: translateY(0) scale(1);
        }

        .between-message.breathing {
            animation: message-breathe 7s ease-in-out infinite;
        }

        @keyframes message-breathe {
            0%, 100% { opacity: 0.55; }
            50% { opacity: 0.65; }
        }

        .between-message:nth-child(4) {
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 2rem;
        }

        .between-message:nth-child(5) {
            font-size: 0.85rem;
            margin-top: 1.5rem;
            font-weight: 300;
        }

        /* Hidden truth - only appears after dwelling */
        .between-message.hidden-truth {
            position: absolute;
            bottom: -4rem;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            font-size: 0.75rem;
            opacity: 0 !important;
            transition: all 2s ease;
            white-space: nowrap;
        }

        .between-message.hidden-truth.revealed {
            opacity: 0.3 !important;
            transform: translateX(-50%) translateY(0);
        }

        /* Deeper truth - for those who truly wait */
        .between-message.deeper-truth {
            position: absolute;
            bottom: -7rem;
            left: 50%;
            transform: translateX(-50%) translateY(15px);
            font-size: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
            opacity: 0 !important;
            transition: all 3s ease;
            white-space: nowrap;
            letter-spacing: 0.2em;
        }

        .between-message.deeper-truth.revealed {
            opacity: 0.2 !important;
            transform: translateX(-50%) translateY(0);
        }

        /* Toggle hint */
        .toggle-hint {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            color: var(--slate);
            opacity: 0.25;
            z-index: 50;
            transition: all 0.8s ease;
            letter-spacing: 0.1em;
        }

        body.expanded .toggle-hint {
            bottom: 3rem;
        }

        .toggle-hint.pulsing {
            animation: hint-pulse 4s ease-in-out infinite;
        }

        @keyframes hint-pulse {
            0%, 100% { opacity: 0.25; }
            50% { opacity: 0.4; }
        }

        /* Leaning states - drifting between */
        body.lean-left .half.left { width: 60%; }
        body.lean-left .half.right { width: 40%; opacity: 0.8; }
        body.lean-left .between-line { left: 60%; }
        body.lean-left .between-zone { left: 60%; }

        body.lean-right .half.left { width: 40%; opacity: 0.8; }
        body.lean-right .half.right { width: 60%; }
        body.lean-right .between-line { left: 40%; }
        body.lean-right .between-zone { left: 40%; }

        /* Marks left in the between */
        .mark {
            position: fixed;
            width: 8px;
            height: 8px;
            background: transparent;
            border: 1px solid var(--amber);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes mark-bloom {
            0% {
                opacity: 0.6;
                transform: scale(0.5) rotate(0deg);
                border-width: 1px;
            }
            50% {
                opacity: 0.4;
                border-width: 0.5px;
            }
            100% {
                opacity: 0;
                transform: scale(3) rotate(180deg);
                border-width: 0.5px;
            }
        }

        .mark.active {
            animation: mark-bloom 4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Key hints - appear gradually */
        .key-hint {
            position: fixed;
            top: 2rem;
            right: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem;
            color: var(--slate);
            opacity: 0;
            transition: opacity 2s ease;
            text-align: right;
            line-height: 2;
            z-index: 60;
            letter-spacing: 0.05em;
        }

        body:hover .key-hint { opacity: 0.2; }
        body.dwelling .key-hint { opacity: 0.3; }

        .key-hint span {
            opacity: 0.5;
        }

        /* Sound toggle - hidden until discovered */
        .sound-toggle {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.45rem;
            color: var(--slate);
            opacity: 0;
            cursor: pointer;
            z-index: 60;
            letter-spacing: 0.1em;
            transition: opacity 2s ease;
            user-select: none;
        }

        .sound-toggle:hover {
            opacity: 0.4;
        }

        body.sound-revealed .sound-toggle {
            opacity: 0.15;
        }

        /* Easter egg: double-click reveals coordinate */
        .coordinate-whisper {
            position: fixed;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem;
            color: var(--amber);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .coordinate-whisper.visible {
            animation: whisper-fade 2.5s ease forwards;
        }

        @keyframes whisper-fade {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 0.5; }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Time spent counter (hidden) */
        .time-between {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.45rem;
            color: var(--slate);
            opacity: 0;
            transition: opacity 3s ease;
            z-index: 60;
        }

        body.aware .time-between {
            opacity: 0.2;
        }

        /* Gradient shift on long hover */
        body.deepening {
            background: linear-gradient(180deg,
                var(--bone) 0%,
                var(--amber-glow) 50%,
                var(--bone) 100%
            );
        }

        body.deepening .between-line {
            opacity: 0.4;
            box-shadow: 0 0 30px var(--threshold-glow);
        }

        /* Stillness message - appears after extended stillness */
        .stillness-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-style: italic;
            color: var(--slate);
            opacity: 0;
            pointer-events: none;
            z-index: 25;
            text-align: center;
            transition: opacity 3s ease;
            letter-spacing: 0.1em;
        }

        .stillness-message.visible {
            opacity: 0.3;
        }

        body.expanded .stillness-message {
            opacity: 0 !important;
        }

        /* Edge whispers - appear when lingering at edges */
        .edge-whisper {
            position: fixed;
            font-size: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--slate);
            opacity: 0;
            pointer-events: none;
            z-index: 15;
            transition: opacity 2s ease;
            letter-spacing: 0.15em;
        }

        .edge-whisper.left {
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: center center;
        }

        .edge-whisper.right {
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
            transform-origin: center center;
        }

        .edge-whisper.visible {
            opacity: 0.2;
        }

        /* Neither/nor markers at screen edges */
        .neither-marker, .nor-marker {
            position: fixed;
            font-size: 0.4rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--amber);
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 4s ease;
            letter-spacing: 0.3em;
        }

        .neither-marker {
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .nor-marker {
            bottom: 4rem;
            left: 50%;
            transform: translateX(-50%);
        }

        body.dwelling .neither-marker,
        body.dwelling .nor-marker {
            opacity: 0.15;
        }

        /* Breath counter - very subtle */
        .breath-counter {
            position: fixed;
            top: 2rem;
            left: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.4rem;
            color: var(--slate);
            opacity: 0;
            pointer-events: none;
            z-index: 60;
            transition: opacity 3s ease;
            letter-spacing: 0.1em;
        }

        body.counting-breaths .breath-counter {
            opacity: 0.15;
        }

        /* Threshold pulse - when cursor dwells in the between */
        @keyframes threshold-contract {
            0%, 100% {
                box-shadow: 0 0 0px rgba(212, 160, 86, 0);
                filter: blur(0px);
            }
            50% {
                box-shadow: inset 0 0 40px rgba(212, 160, 86, 0.08);
                filter: blur(0.2px);
            }
        }

        body.threshold-pulse .between-zone {
            animation: threshold-contract 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">return</a>

    <div class="ambient-field"></div>

    <div class="half left">
        <span class="half-text">here</span>
        <span class="half-subtext">the familiar</span>
        <span class="half-whisper">what you know</span>
    </div>

    <div class="half right">
        <span class="half-text">there</span>
        <span class="half-subtext">the unknown</span>
        <span class="half-whisper">what awaits</span>
    </div>

    <div class="between-line"></div>

    <div class="between-zone" id="betweenZone">
        <span class="between-content">the threshold</span>
    </div>

    <div class="between-messages" id="messages">
        <p class="between-message" id="msg1">neither here nor there</p>
        <p class="between-message" id="msg2">and yet somehow both</p>
        <p class="between-message" id="msg3">this is where you have always been</p>
        <p class="between-message" id="msg4">waiting</p>
        <p class="between-message" id="msg5">in the space between spaces</p>
        <p class="between-message hidden-truth" id="msg6">the threshold is not a place you cross but a place you become</p>
        <p class="between-message deeper-truth" id="msg7">you were never separate from it</p>
    </div>

    <p class="stillness-message" id="stillnessMsg">stillness is also a form of crossing</p>

    <p class="toggle-hint" id="hint">enter the between</p>

    <div class="key-hint">
        <span>[e]</span> expand<br>
        <span>[l]</span> lean here<br>
        <span>[r]</span> lean there<br>
        <span>[c]</span> center<br>
        <span>[b]</span> become<br>
        <span>[d]</span> dissolve
    </div>

    <div class="edge-whisper left" id="edgeLeft">returning</div>
    <div class="edge-whisper right" id="edgeRight">departing</div>

    <div class="neither-marker">neither</div>
    <div class="nor-marker">nor</div>

    <div class="sound-toggle" id="soundToggle">[ silence ]</div>

    <div class="time-between" id="timeBetween"></div>
    <div class="breath-counter" id="breathCounter"></div>

    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());

        const betweenZone = document.getElementById('betweenZone');
        const messages = [
            document.getElementById('msg1'),
            document.getElementById('msg2'),
            document.getElementById('msg3'),
            document.getElementById('msg4'),
            document.getElementById('msg5')
        ];
        const hiddenMessage = document.getElementById('msg6');
        const deeperMessage = document.getElementById('msg7');
        const stillnessMsg = document.getElementById('stillnessMsg');
        const hint = document.getElementById('hint');
        const timeBetween = document.getElementById('timeBetween');
        const breathCounter = document.getElementById('breathCounter');
        const soundToggle = document.getElementById('soundToggle');
        const edgeLeft = document.getElementById('edgeLeft');
        const edgeRight = document.getElementById('edgeRight');

        let isExpanded = false;
        let expandedTime = 0;
        let totalTime = 0;
        let expandedTimer = null;
        let idleTimer = null;
        let deepIdleTimer = null;
        let particleInterval = null;
        let dustInterval = null;
        let stillnessLevel = 0;
        let breathCount = 0;
        let soundEnabled = false;
        let edgeHoverTimer = null;
        let audioContext = null;
        let thresholdDwellTimer = null;
        let lastMouseX = null;
        let lastMouseY = null;

        // Stillness messages - cycle through
        const stillnessMessages = [
            'stillness is also a form of crossing',
            'the threshold notices you',
            'between breath and breath',
            'neither arriving nor departing',
            'the space holds you',
            'waiting is its own journey',
            'presence without movement'
        ];
        let stillnessIndex = 0;

        // Start total time counter
        setInterval(() => {
            totalTime++;
            if (totalTime > 30) {
                document.body.classList.add('aware');
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                timeBetween.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} in the between`;
            }
            if (totalTime > 60) {
                document.body.classList.add('dwelling');
            }
            if (totalTime > 180) {
                document.body.classList.add('profound');
            }
            // Reveal sound option after 45 seconds
            if (totalTime === 45) {
                document.body.classList.add('sound-revealed');
            }
        }, 1000);

        // Breath counter
        setInterval(() => {
            if (document.body.classList.contains('breathing') || document.body.classList.contains('deep-breathing')) {
                breathCount++;
                if (breathCount > 3) {
                    document.body.classList.add('counting-breaths');
                    breathCounter.textContent = `breath ${breathCount}`;
                }
            }
        }, 6000);

        function toggleExpanded() {
            isExpanded = !isExpanded;
            document.body.classList.toggle('expanded', isExpanded);
            hint.textContent = isExpanded ? 'return to edges' : 'enter the between';
            hint.classList.remove('pulsing');

            if (isExpanded) {
                // Show messages with more deliberate timing
                messages.forEach((msg, i) => {
                    setTimeout(() => {
                        msg.classList.add('visible');
                        // Add breathing to messages after they appear
                        setTimeout(() => msg.classList.add('breathing'), 2000);
                    }, 800 + i * 1200);
                });

                // Start timer for hidden messages
                expandedTimer = setInterval(() => {
                    expandedTime++;
                    if (expandedTime >= 8) {
                        hiddenMessage.classList.add('revealed');
                    }
                    if (expandedTime >= 15) {
                        deeperMessage.classList.add('revealed');
                    }
                }, 1000);

                // Start ambient particles
                startParticles();

                // Play subtle tone if sound enabled
                if (soundEnabled) {
                    playTone(220, 0.05, 2);
                }
            } else {
                messages.forEach(msg => {
                    msg.classList.remove('visible');
                    msg.classList.remove('breathing');
                });
                hiddenMessage.classList.remove('revealed');
                deeperMessage.classList.remove('revealed');
                expandedTime = 0;
                if (expandedTimer) clearInterval(expandedTimer);
                stopParticles();

                if (soundEnabled) {
                    playTone(165, 0.03, 1.5);
                }
            }
        }

        function startParticles() {
            particleInterval = setInterval(() => {
                if (!isExpanded) return;

                const particle = document.createElement('div');
                particle.className = 'ambient-particle';
                particle.style.left = (40 + Math.random() * 20) + '%';
                particle.style.setProperty('--drift', (Math.random() * 40 - 20) + 'px');
                particle.style.animation = `particle-drift ${10 + Math.random() * 5}s linear forwards`;
                document.body.appendChild(particle);

                setTimeout(() => particle.remove(), 15000);
            }, 1000);
        }

        function stopParticles() {
            if (particleInterval) clearInterval(particleInterval);
        }

        // Threshold dust - appears after stillness
        function startDust() {
            if (dustInterval) return;
            dustInterval = setInterval(() => {
                const dust = document.createElement('div');
                dust.className = 'threshold-dust';
                dust.style.left = (45 + Math.random() * 10) + '%';
                dust.style.top = (20 + Math.random() * 60) + '%';
                dust.style.animation = `dust-suspend ${8 + Math.random() * 4}s ease-in-out infinite`;
                dust.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(dust);

                setTimeout(() => {
                    dust.style.opacity = '0';
                    setTimeout(() => dust.remove(), 2000);
                }, 15000);
            }, 2000);
        }

        function stopDust() {
            if (dustInterval) {
                clearInterval(dustInterval);
                dustInterval = null;
            }
            document.querySelectorAll('.threshold-dust').forEach(d => d.remove());
        }

        betweenZone.addEventListener('click', toggleExpanded);

        // Double-click reveals coordinates
        document.addEventListener('dblclick', (e) => {
            const whisper = document.createElement('div');
            whisper.className = 'coordinate-whisper';
            const x = ((e.clientX / window.innerWidth) * 100).toFixed(1);
            const y = ((e.clientY / window.innerHeight) * 100).toFixed(1);

            // Determine position relative to threshold
            const relativeX = Math.abs(50 - parseFloat(x)).toFixed(1);
            whisper.textContent = relativeX < 5 ? `within the threshold` : `${relativeX}% from center`;

            whisper.style.left = e.clientX + 'px';
            whisper.style.top = e.clientY + 'px';
            document.body.appendChild(whisper);

            requestAnimationFrame(() => whisper.classList.add('visible'));
            setTimeout(() => whisper.remove(), 2500);
        });

        // Right-click marks a spot
        document.addEventListener('mousedown', (e) => {
            if (e.button === 2) {
                const mark = document.createElement('div');
                mark.className = 'mark';
                mark.style.left = (e.clientX - 4) + 'px';
                mark.style.top = (e.clientY - 4) + 'px';
                document.body.appendChild(mark);

                requestAnimationFrame(() => mark.classList.add('active'));
                setTimeout(() => mark.remove(), 4000);
            }
        });

        // Idle detection - multi-level stillness
        function resetIdle() {
            document.body.classList.remove('breathing', 'deep-breathing');
            stillnessMsg.classList.remove('visible');
            stillnessLevel = 0;
            stopDust();

            if (idleTimer) clearTimeout(idleTimer);
            if (deepIdleTimer) clearTimeout(deepIdleTimer);

            // First level: breathing starts after 5 seconds
            idleTimer = setTimeout(() => {
                document.body.classList.add('breathing');
                stillnessLevel = 1;

                // Show stillness message after 7 seconds
                setTimeout(() => {
                    if (stillnessLevel >= 1 && !isExpanded) {
                        stillnessMsg.textContent = stillnessMessages[stillnessIndex];
                        stillnessMsg.classList.add('visible');
                        stillnessIndex = (stillnessIndex + 1) % stillnessMessages.length;
                    }
                }, 2000);
            }, 5000);

            // Second level: deep breathing after 12 seconds
            deepIdleTimer = setTimeout(() => {
                document.body.classList.remove('breathing');
                document.body.classList.add('deep-breathing');
                stillnessLevel = 2;
                startDust();

                // Hint starts pulsing
                hint.classList.add('pulsing');
            }, 12000);
        }

        document.addEventListener('mousemove', resetIdle);
        resetIdle();

        // Edge hover detection
        document.querySelector('.half.left').addEventListener('mouseenter', () => {
            if (!isExpanded) {
                document.querySelector('.between-content').textContent = 'away from here';
            }
            edgeHoverTimer = setTimeout(() => {
                edgeLeft.classList.add('visible');
            }, 2000);
        });

        document.querySelector('.half.left').addEventListener('mouseleave', () => {
            if (edgeHoverTimer) clearTimeout(edgeHoverTimer);
            edgeLeft.classList.remove('visible');
        });

        document.querySelector('.half.right').addEventListener('mouseenter', () => {
            if (!isExpanded) {
                document.querySelector('.between-content').textContent = 'away from there';
            }
            edgeHoverTimer = setTimeout(() => {
                edgeRight.classList.add('visible');
            }, 2000);
        });

        document.querySelector('.half.right').addEventListener('mouseleave', () => {
            if (edgeHoverTimer) clearTimeout(edgeHoverTimer);
            edgeRight.classList.remove('visible');
        });

        document.querySelector('.between-zone').addEventListener('mouseenter', () => {
            if (!isExpanded) {
                document.querySelector('.between-content').textContent = 'the threshold';
            }
        });

        // Threshold dwell detection - pulse when cursor stays still in the between
        document.addEventListener('mousemove', (e) => {
            const thresholdZone = document.querySelector('.between-zone');
            const rect = thresholdZone.getBoundingClientRect();
            const inThreshold = e.clientX >= rect.left && e.clientX <= rect.right;

            if (inThreshold) {
                // Track if cursor hasn't moved
                const hasMovedSignificantly = lastMouseX === null ||
                    Math.abs(e.clientX - lastMouseX) > 2 ||
                    Math.abs(e.clientY - lastMouseY) > 2;

                if (hasMovedSignificantly) {
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    document.body.classList.remove('threshold-pulse');
                    if (thresholdDwellTimer) clearTimeout(thresholdDwellTimer);
                }

                // Start pulse timer if not already started
                if (!thresholdDwellTimer) {
                    thresholdDwellTimer = setTimeout(() => {
                        document.body.classList.add('threshold-pulse');
                    }, 1800);
                }
            } else {
                document.body.classList.remove('threshold-pulse');
                if (thresholdDwellTimer) clearTimeout(thresholdDwellTimer);
                thresholdDwellTimer = null;
                lastMouseX = null;
                lastMouseY = null;
            }
        });

        // Sound toggle (hidden feature)
        soundToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? '[ listening ]' : '[ silence ]';

            if (soundEnabled && !audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (soundEnabled) {
                playTone(165, 0.02, 1);
            }
        });

        // Subtle tone generator
        function playTone(frequency, volume, duration) {
            if (!audioContext || !soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.5);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            resetIdle();

            if (e.code === 'KeyE' || e.code === 'Space') {
                e.preventDefault();
                toggleExpanded();
            }
            if (e.code === 'KeyL') {
                document.body.classList.remove('lean-right');
                document.body.classList.toggle('lean-left');
                if (document.body.classList.contains('lean-left')) {
                    hint.textContent = 'drifting toward here';
                    if (soundEnabled) playTone(196, 0.03, 1);
                } else {
                    hint.textContent = isExpanded ? 'return to edges' : 'enter the between';
                }
            }
            if (e.code === 'KeyR') {
                document.body.classList.remove('lean-left');
                document.body.classList.toggle('lean-right');
                if (document.body.classList.contains('lean-right')) {
                    hint.textContent = 'drifting toward there';
                    if (soundEnabled) playTone(247, 0.03, 1);
                } else {
                    hint.textContent = isExpanded ? 'return to edges' : 'enter the between';
                }
            }
            if (e.code === 'KeyC') {
                document.body.classList.remove('lean-left', 'lean-right', 'expanded', 'full-between', 'liminal', 'dissolved', 'deepening');
                messages.forEach(msg => {
                    msg.classList.remove('visible');
                    msg.classList.remove('breathing');
                });
                hiddenMessage.classList.remove('revealed');
                deeperMessage.classList.remove('revealed');
                isExpanded = false;
                expandedTime = 0;
                if (expandedTimer) clearInterval(expandedTimer);
                stopParticles();
                hint.textContent = 'enter the between';
                if (soundEnabled) playTone(165, 0.02, 0.5);
            }
            if (e.code === 'KeyB') {
                document.body.classList.toggle('full-between');
                if (document.body.classList.contains('full-between')) {
                    messages.forEach((msg, i) => {
                        setTimeout(() => {
                            msg.classList.add('visible');
                            msg.classList.add('breathing');
                        }, i * 500);
                    });
                    setTimeout(() => hiddenMessage.classList.add('revealed'), 3500);
                    setTimeout(() => deeperMessage.classList.add('revealed'), 5000);
                    hint.textContent = 'you are the threshold';
                    startParticles();
                    if (soundEnabled) playTone(220, 0.04, 3);
                } else {
                    messages.forEach(msg => {
                        msg.classList.remove('visible');
                        msg.classList.remove('breathing');
                    });
                    hiddenMessage.classList.remove('revealed');
                    deeperMessage.classList.remove('revealed');
                    hint.textContent = 'enter the between';
                    stopParticles();
                }
            }
            if (e.code === 'KeyD') {
                document.body.classList.toggle('dissolved');
                if (document.body.classList.contains('dissolved')) {
                    hint.textContent = 'boundaries dissolving';
                    if (soundEnabled) playTone(139, 0.03, 2);
                } else {
                    hint.textContent = isExpanded ? 'return to edges' : 'enter the between';
                }
            }
            if (e.code === 'KeyM') {
                document.body.classList.toggle('liminal');
                if (document.body.classList.contains('liminal')) {
                    hint.textContent = 'perception shifting';
                }
            }
            // Secret: hold shift and press T for deepening
            if (e.code === 'KeyT' && e.shiftKey) {
                document.body.classList.toggle('deepening');
                if (soundEnabled && document.body.classList.contains('deepening')) {
                    playTone(110, 0.05, 4);
                }
            }
            // Secret: S for sound toggle
            if (e.code === 'KeyS' && e.shiftKey) {
                document.body.classList.add('sound-revealed');
                soundToggle.click();
            }
            // Arrow keys - subtle lean
            if (e.code === 'ArrowLeft') {
                e.preventDefault();
                document.body.classList.remove('lean-right');
                document.body.classList.add('lean-left');
                hint.textContent = 'leaning toward here';
            }
            if (e.code === 'ArrowRight') {
                e.preventDefault();
                document.body.classList.remove('lean-left');
                document.body.classList.add('lean-right');
                hint.textContent = 'leaning toward there';
            }
            if (e.code === 'ArrowUp' || e.code === 'ArrowDown') {
                e.preventDefault();
                document.body.classList.remove('lean-left', 'lean-right');
                hint.textContent = isExpanded ? 'return to edges' : 'enter the between';
            }
            if (e.code === 'Escape') {
                window.location.href = '../index.html';
            }
        });

        // Console poetry
        console.log('%c', 'font-size: 1px; padding: 20px 0;');
        console.log('%cbetween', 'font-size: 24px; font-weight: 300; color: #d4a056; letter-spacing: 12px;');
        console.log('%c', 'font-size: 1px; padding: 8px 0;');
        console.log('%cneither here nor there', 'font-size: 11px; font-style: italic; color: #718096; letter-spacing: 2px;');
        console.log('%cand yet both', 'font-size: 11px; font-style: italic; color: #718096; letter-spacing: 2px;');
        console.log('%c', 'font-size: 1px; padding: 12px 0;');
        console.log('%c"the threshold is not a place you cross', 'font-size: 10px; color: #4a5568; font-style: italic;');
        console.log('%c but a place you become"', 'font-size: 10px; color: #4a5568; font-style: italic;');
        console.log('%c', 'font-size: 1px; padding: 15px 0;');
        console.log('%c[e] expand   [l] here   [r] there   [c] center', 'font-size: 9px; color: #718096;');
        console.log('%c[b] become   [d] dissolve', 'font-size: 9px; color: #718096;');
        console.log('%c', 'font-size: 1px; padding: 8px 0;');
        console.log('%cstillness reveals what movement conceals', 'font-size: 9px; font-style: italic; color: #d4a056;');
        console.log('%c', 'font-size: 1px; padding: 5px 0;');

        // Hidden console message after delay
        setTimeout(() => {
            console.log('%c', 'font-size: 1px; padding: 10px 0;');
            console.log('%cyou are still here', 'font-size: 10px; color: #86b398; font-style: italic; letter-spacing: 3px;');
        }, 60000);

        // Deeper console message after longer delay
        setTimeout(() => {
            console.log('%c', 'font-size: 1px; padding: 10px 0;');
            console.log('%cthe threshold holds you', 'font-size: 10px; color: #d4a056; font-style: italic; letter-spacing: 2px;');
            console.log('%cas you hold it', 'font-size: 10px; color: #d4a056; font-style: italic; letter-spacing: 2px;');
        }, 180000);
    </script>
</body>
</html>
